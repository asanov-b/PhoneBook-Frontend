<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PhoneBook - Admin</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Phone Book - Admin</h2>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
    </div>

    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="searchForm" class="row g-3">
                <div class="col-md-2"><input class="form-control" id="firstName" placeholder="First Name"></div>
                <div class="col-md-2"><input class="form-control" id="lastName" placeholder="Last Name"></div>
                <div class="col-md-2"><input class="form-control" id="phoneNumber" placeholder="Phone Number"></div>
                <div class="col-md-2"><input class="form-control" id="country" placeholder="Country"></div>
                <div class="col-md-2"><input class="form-control" id="city" placeholder="City"></div>
                <div class="col-md-2"><input class="form-control" id="street" placeholder="Street"></div>
                <div class="col-md-12 mt-2">
                    <button class="btn btn-primary">Search</button>
                    <button type="button" class="btn btn-secondary" id="resetBtn">Reset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add / Update -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>Add / Update Contact</h5>
            <form id="contactForm" class="row g-3">
                <input type="hidden" id="contactId">

                <div class="col-md-2">
                    <input class="form-control" id="addFirstName" placeholder="First Name" required>
                    <div class="invalid-feedback" id="errorFirstName"></div>
                </div>
                <div class="col-md-2">
                    <input class="form-control" id="addLastName" placeholder="Last Name" required>
                    <div class="invalid-feedback" id="errorLastName"></div>
                </div>
                <div class="col-md-2">
                    <input class="form-control" id="addPhoneNumber" placeholder="+998 90 123 45 67" required>
                    <div class="invalid-feedback" id="errorPhoneNumber"></div>
                </div>
                <div class="col-md-2">
                    <input class="form-control" id="addCountry" placeholder="Country" required>
                    <div class="invalid-feedback" id="errorCountry"></div>
                </div>
                <div class="col-md-2">
                    <input class="form-control" id="addCity" placeholder="City" required>
                    <div class="invalid-feedback" id="errorCity"></div>
                </div>
                <div class="col-md-2">
                    <input class="form-control" id="addStreet" placeholder="Street" required>
                    <div class="invalid-feedback" id="errorStreet"></div>
                </div>

                <div class="col-md-12 mt-2">
                    <button class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="card">
        <div class="card-body">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Phone</th>
                    <th>Country</th>
                    <th>City</th>
                    <th>Street</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="contactsBody"></tbody>
            </table>
            <ul class="pagination" id="pagination"></ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const API = "http://localhost:8080/api/v1/contact";
    const pageSize = 10;
    let currentPage = 0;
    let cachedContacts = [];

    /* ---------- ROLE CHECK ---------- */
    function parseJwt(token) {
        if (!token) return null;
        return JSON.parse(atob(token.split('.')[1]));
    }
    function getRole() {
        const token = localStorage.getItem("token");
        if (!token) return null;
        const payload = parseJwt(token);
        return payload.role || payload.roles?.[0] || null;
    }

    // Axios token
    axios.interceptors.request.use(config => {
        const token = localStorage.getItem("token");
        if (token) config.headers.Authorization = token;
        return config;
    });

    /* ---------- FETCH ---------- */
    async function fetchContacts(page = 0, params = {}) {
        params.page = page;
        params.size = pageSize;

        const searchParams = { ...params };
        delete searchParams.page;
        delete searchParams.size;

        const hasSearch = Object.values(searchParams).some(v => v);
        const url = hasSearch ? API + "/search" : API;

        const res = await axios.get(url, { params });
        const data = res.data;

        currentPage = data.number;
        cachedContacts = data.content;

        renderTable();
        renderPagination(data.totalPages, data.number);
    }

    /* ---------- TABLE ---------- */
    function renderTable() {
        const tbody = document.getElementById("contactsBody");
        tbody.innerHTML = "";
        cachedContacts.forEach(c => {
            tbody.innerHTML += `
            <tr>
                <td>${c.firstName}</td>
                <td>${c.lastName}</td>
                <td>${c.phoneNumber}</td>
                <td>${c.country}</td>
                <td>${c.city}</td>
                <td>${c.street}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editContact('${c.id}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteContact('${c.id}')">Delete</button>
                </td>
            </tr>`;
        });
    }

    /* ---------- PAGINATION ---------- */
    function renderPagination(totalPages, activePage) {
        const ul = document.getElementById("pagination");
        ul.innerHTML = "";
        for (let i = 0; i < totalPages; i++) {
            ul.innerHTML += `
            <li class="page-item ${i === activePage ? "active" : ""}">
                <button class="page-link" onclick="goPage(${i})">${i + 1}</button>
            </li>`;
        }
    }
    function goPage(p) { currentPage = p; fetchContacts(p, getSearchParams()); }

    /* ---------- CRUD ---------- */
    async function deleteContact(id) {
        if (!confirm("Delete contact?")) return;
        await axios.delete(API + "/" + id);
        fetchContacts(currentPage, getSearchParams());
    }

    function editContact(id) {
        const c = cachedContacts.find(x => x.id === id);
        contactId.value = c.id;
        addFirstName.value = c.firstName;
        addLastName.value = c.lastName;
        addPhoneNumber.value = c.phoneNumber;
        addCountry.value = c.country;
        addCity.value = c.city;
        addStreet.value = c.street;
        clearValidation();
    }

    /* ---------- VALIDATION HELPER ---------- */
    function clearValidation() {
        const fields = ["FirstName","LastName","PhoneNumber","Country","City","Street"];
        fields.forEach(f=>{
            const input = document.getElementById("add"+f);
            const errorDiv = document.getElementById("error"+f);
            input.classList.remove("is-invalid");
            errorDiv.innerText = "";
        });
    }

    /* ---------- FORMS ---------- */
    contactForm.onsubmit = async e => {
        e.preventDefault();
        clearValidation();

        const id = contactId.value;
        const data = {
            firstName: addFirstName.value,
            lastName: addLastName.value,
            phoneNumber: addPhoneNumber.value,
            country: addCountry.value,
            city: addCity.value,
            street: addStreet.value
        };

        try {
            if (id) await axios.put(API + "/" + id, data);
            else await axios.post(API, data);

            contactForm.reset();
            contactId.value = "";
            fetchContacts(currentPage, getSearchParams());
        } catch (error) {
            if (error.response && error.response.status === 400) {
                const messages = error.response.data;
                for (const field in messages) {
                    const input = document.getElementById("add"+capitalize(field));
                    const errorDiv = document.getElementById("error"+capitalize(field));
                    if(input && errorDiv){
                        input.classList.add("is-invalid");
                        errorDiv.innerText = messages[field];
                    }
                }
            } else {
                console.error(error);
                alert("Something went wrong!");
            }
        }
    };

    searchForm.onsubmit = e => { e.preventDefault(); fetchContacts(0, getSearchParams()); };
    resetBtn.onclick = () => { searchForm.reset(); fetchContacts(0, {}); };

    function getSearchParams() {
        return {
            firstName: firstName.value,
            lastName: lastName.value,
            phoneNumber: phoneNumber.value,
            country: country.value,
            city: city.value,
            street: street.value
        };
    }

    function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

    function logout() {
        if (!confirm("Are you sure you want to logout?")) return;
        localStorage.removeItem("token");
        window.location.href = "login.html";
    }

    (function authCheck(){
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "login.html";
        }
    })();

    /* ---------- INIT ---------- */
    fetchContacts();
</script>
</body>
</html>
